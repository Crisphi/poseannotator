<!DOCTYPE html>
<html>
  <head>
    <title>Pose Annotator</title>
    <meta charset="UTF-8">
    <meta name="author" content="Cristian Ortega Singer">
    <script src="https://code.jquery.com/jquery-latest.js"></script>
    <style>
      div {border-style: dotted;}
      body {display: grid;}
      #header{
        grid-column: 1/span 3;
        grid-row: 1/ span 2;
      }
      #sidebar{
        grid-column: 1;
        grid-row: 2/span 7;
      }
      #workspace{
        grid-column: 2/span 3;
        grid-row: 2/span 5;
        grid-template-columns: max-content;
      }

      #footer{
        grid-column: 1/span 3;
        grid-row: 7;
      }

      .gridItem{display:grid;}

      #img-svg-wrap{
        position: relative;
        display: inline-block;
      }

      #image{
        display: absolute;
        max-width: 100%;
        min-width: 100%;
        height: auto;
      }

      #svg{
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      polyline{
        fill:none;
        stroke-width:3;
      }
      .black{
        stroke:black;
      }
      .orange{
        stroke:orange;
      }
    </style>
  </head>
  <body>
    <div id="header" class="gridItem">
      Pose Annotator
      <form name="upload-metadata">
        <input type="file" id="metadata" accept="application/json" multiple>
        </br>
        <input type="file" id="images" accept="image/*" multiple>
        <button type="button" id="imageSubmit" onclick="handleFiles();">Load Files</button>
      </form>
    </div>
    <div id="main" class="gridItem">
      <div id="sidebar" class="gridItem">
        Here are going to be all the tools and an overview of the images
        <div id="tools">Tools</div>
        <div id="files">Files</div>
        <div id="arrows">
          <button type="button" id="lastPic" onclick="previousImage();">Prev</button>
          <button type="button" id="nextPic" onclick="nextImage();">Next</button>
        </div>
      </div>
      <div id="workspace" class="gridItem">
        <div id="img-svg-wrap">
          <img x= 0 y= 0 id="image" href="" alt="current Picture">
          <svg id="svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <!--<polyline id="polyl" style="fill:none;stroke:black;stroke-width:3" points="606.253, 219.699, 607.966, 243.867, 587.274, 243.883, 575.187, 280.014, 588.977, 264.551, 626.971, 243.854, 637.244, 278.34, 632.136, 297.325, 611.349, 311.086, 597.578, 311.151, 601.005, 357.737, 604.533, 404.276, 623.486, 309.444, 626.952, 352.629, 628.599, 400.847, 601.088, 216.209, 611.397, 214.536, 599.217, 223.13,  614.927, 217.92, 628.695, 409.502, 637.276, 407.778, 625.206, 406.001, 611.426, 411.236, 602.74, 409.529, 609.672, 406.07"/>-->
            <polyline style="fill:none;stroke:black;stroke-width:3" points= "606.253, 219.699, 607.966, 243.867,587.274, 243.883, 575.187, 280.014, 588.977, 264.551"/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points="607.966, 243.867, 626.971, 243.854, 637.244, 278.34, 632.136, 297.325 "/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points="607.966, 243.867, 611.349, 311.086, 597.578, 311.151, 601.005, 357.737, 604.533, 404.276"/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points="611.349, 311.086, 623.486, 309.444, 626.952, 352.629, 628.599, 400.847"/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points="599.217, 223.13, 601.088, 216.209, 606.253, 219.699"/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points=" 606.253, 219.699, 611.397, 214.536, 614.927, 217.92"/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points="604.533, 404.276, 611.426, 411.236, 602.74, 409.529"/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points="604.533, 404.276, 609.672, 406.07"/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points="628.599, 400.847, 628.695, 409.502, 637.276, 407.778"/>
            <polyline style="fill:none;stroke:black;stroke-width:3" points="628.599, 400.847, 625.206, 406.001"/>
          </svg>
        </div>
      </div>
    </div>
    <div id="footer" class="gridItem">
      Footer
    </div>

    <script type="text/javascript">
    "use strict";
      var IMG_FILEPATH = "img/";
      var META_FILEPATH = "metadata/";
      var single_meta_file = false;
      var meta_file_list = {};
      var annotations;
      var image_file_list = {};
      var current_image_id;
      var current_image_source;
      var color = "black";

      var svgNS = "http://www.w3.org/2000/svg";

      // Check for the various File API support.
      if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
        alert('The File APIs are not fully supported in this browser.');
      }

      document.addEventListener('keydown', function(event) {
        if(event.keyCode == 37) {
          console.log('Left was pressed');
          previousImage();
        }
        else if(event.keyCode == 39) {
          console.log('Right was pressed');
          nextImage();
        }
        else if(event.keyCode == 40) {
          console.log('Down was pressed');
          changeAnnoColor();
        }
      });

      function loadMetaFileSingle(){
        single_meta_file = true;

        console.log(meta_file_list);
        for(var i = 0; i < meta_file_list.length; i++){
          var d = meta_file_list[i];
          console.log(d);
          var reader = new FileReader();
          reader.onload = getAnnotations;
          reader.readAsText(d).then(loadAnnotationsSingle());
        }
        function getAnnotations(t, callback = function(){loadAnnotations();}){
          let lines = t.target.result;
          var a = JSON.parse(lines);
          annotations = $.extend(annotations,a);
          console.log("Annotations:");
          console.log(annotations);
          callback();
        }

      }

      function loadMetaFiles(){
        single_meta_file = false;

        console.log(meta_file_list);
        var id = current_image_source.split(".")[0];
        var patt = new RegExp(id + "_");
        var meta_id;
        console.log(id);
        for(var i = 0; i < meta_file_list.length; i++){
          var d = meta_file_list[i];
          if(patt.test(d.name)){
            console.log(d);
            meta_id = d;
          }
        }
        if(meta_id){
          var reader = new FileReader();
          reader.onload = getAnnotations;
          console.log(meta_id);
          reader.readAsText(meta_id);
        }

        function getAnnotations(t, callback = function(){loadAnnotations();}){
          console.log(callback);
          let lines = t.target.result;
          var a = JSON.parse(lines);
          annotations = $.extend(annotations,a);
          console.log("Annotations:");
          console.log(annotations);
          callback();
        }
      }

      function handleFiles(){
        image_file_list = document.getElementById("images").files;
        meta_file_list = document.getElementById("metadata").files;
        if(!image_file_list[0]){
          alert("You have to select image files before you can continue!");
        }else if(!meta_file_list[0]){
          alert("You have to select JSON files before you can continue!");
        }else if(image_file_list[0] && meta_file_list[0]){
          if(annotations){
            if(confirm("Annotations already included! Do you want to replace annotation File(s)?")){
              current_image_id = 0;
              loadImage();
              annotations = {};
              if(meta_file_list.length > 1){
                loadMetaFiles();
              }else{
                loadMetaFileSingle();
              }
            }
          }else{
            current_image_id = 0;
            loadImage();
            annotations = {};
            if(meta_file_list.length > 1){
              loadMetaFiles();
            }else{
              loadMetaFileSingle();
            }
          }
        }
      }

      function loadImage(){
        destroyPolylines();
        if(!image_file_list[current_image_id]){
          console.log(current_image_id);
          alert("An Error occured! No Image Id found.")
        }else{
          var imag = document.getElementById("image");
          current_image_source = image_file_list[current_image_id].name;

          if(imag.complete){
            var new_image = new Image();
            new_image.id = "image";
            new_image.src = IMG_FILEPATH + current_image_source;
            imag.parentNode.insertBefore(new_image, imag);
            imag.parentNode.removeChild(imag);
          }
        }
      }

      function nextImage(){
        if(current_image_id >= image_file_list.length -1){
          current_image_id = 0;
        }else{
          current_image_id++;
        }
        loadImage();
        if(single_meta_file){
          loadMetaFileSingle();
        }else{
          loadMetaFiles();
        }
      }

      function previousImage(){
        if(current_image_id <= 0){
          current_image_id = image_file_list.length - 1;
        }else{
          current_image_id--;
        }
        loadImage();
        if(single_meta_file){
          loadMetaFileSingle();
        }else{
          loadMetaFiles();
        }
      }

      function loadAnnotationsSingle(){
        var results = [];
        var anno_image_id;
        for(var j=0; j < annotations["images"].length; j++){
          if(annotations["images"][j]["file_name"] == current_image_source){
            anno_image_id = annotations["images"][j]["id"];
          }
        }
        console.log(anno_image_id);
        if(anno_image_id){
          for(var k= 0; k < annotations["annotations"].length; k++){
            if(annotations["annotations"][k]["image_id"] == anno_image_id){
              results.push(annotations["annotations"][k]);
            }
          }
        }else{
          console.log("image_id not found");
        }
        console.log(results);
        /**if(results.length > 0){
          displayAnnotations(results);
        }**/
      }

      function loadAnnotations(){
        var results = [];
        var p = annotations["people"];
        console.log(p);
        for(var i = 0; i < p.length; i++){
          var t = p[i]["pose_keypoints_2d"];
          console.log(t);
          results.push(t);
        }
        console.log("Results:");
        console.log(results);
        for(var j= 0; j < results.length; j++){
          displayAnnotations(results[j]);
        }
      }

      function displayAnnotations(r){
        var points = [];

        for(var i = 0; i < r.length; i++){
          if((i+1) % 3 != 0){
            points.push(r[i]);
          }
        }
        console.log("Points:");
        console.log(points);

        var head1 = [points[0],points[1],points[30],points[31],points[34],points[35]];
        var head2 = [points[0],points[1],points[32],points[33],points[36],points[37]];
        var spine = [points[0],points[1],points[2],points[3],points[16],points[17]];
        var armL = [points[2],points[3],points[4],points[5],points[6],points[7],points[8],points[9]];
        var armR = [points[2],points[3],points[10],points[11],points[12],points[13],points[14],points[15]];
        var legL = [points[16],points[17],points[18],points[19],points[20],points[21],points[22],points[23],points[44],points[45], points[46],points[47]];
        var legR = [points[16],points[17],points[24],points[25],points[26],points[27],points[28],points[29],points[38],points[39],points[40],points[41]];
        var footL = [points[22],points[23],points[48],points[49]];
        var footR = [points[28],points[29],points[42],points[43]];

        var bodyparts = [head1, head2, spine, armL, armR, legL, legR, footL, footR];
        console.log(bodyparts);

        for(var i = 0; i < bodyparts.length; i++){
          for(var j = 0; j < bodyparts[i].length; j++){
            console.log(bodyparts[i][j]);
            if(bodyparts[i][j] == 0){
              console.log("spliced!");
              bodyparts[i].splice(j,1);
              j--;
            }
          }
          console.log(bodyparts[i]);
        }
        console.log(bodyparts);
        for(var i = 0; i < bodyparts.length; i++){
          var strPoints = bodyparts[i].toString();
          createPolyline(strPoints);
        }
      }

      function createPolyline(p){
        var polyline = document.createElementNS(svgNS, "polyline");
        polyline.setAttributeNS(null, "points", p);
        polyline.setAttributeNS(null, "class", color);

        document.getElementById("svg").appendChild(polyline);
      }

      function destroyPolylines(){
        var svg = document.getElementById("svg");
        while (svg.firstChild) {
          svg.removeChild(svg.lastChild);
        }
      }

      function displayAnnotationsSingle(r){
        var points = [];
        for(var i = 0; i < r.length; i++){
          var rawPoints = r[i].keypoints;
          console.log(rawPoints);
          for(var j = 0; j < rawPoints.length; j++){
            if((j+1) % 3 != 0){
              points.push(rawPoints[j]);
            }
          }
          console.log(points);
          var strPoints = points.toString();
          var imag = document.getElementById("image");
          if(imag.complete){
            var poly = new SVGPolylineElement();
            poly.id = "annotation" + i;
            poly.points = strPoints;
            poly.parentNode.insertBefore(poly, imag);
          }
        }
      }

      function changeAnnoColor(){
        var svg = document.getElementById("svg");
        if(color == "black"){
          color = "orange"
        }else{
          color ="black"
        }
        for(var i = 0; i < svg.childNodes.length; i++){
          svg.childNodes[i].setAttributeNS(null, "class", color);
        }
      }


    </script>
  </body>
</html>
